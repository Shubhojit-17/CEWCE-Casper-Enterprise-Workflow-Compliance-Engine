// =============================================================================
// CEWCE - Casper Enterprise Workflow & Compliance Engine
// Prisma Database Schema
// =============================================================================
// This schema maps to the Railway PostgreSQL database with proper column mappings
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// Authentication & User Management
// =============================================================================

model User {
  id            String   @id @default(cuid())
  email         String?  @unique
  passwordHash  String?  @map("password_hash")
  displayName   String?  @map("name")
  publicKey     String?  @unique @map("public_key")
  accountHash   String?  @unique @map("account_hash")
  isActive      Boolean  @default(true) @map("is_active")
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  lastLoginAt   DateTime? @map("last_login_at")
  metadata      Json?
  
  // Profile fields (added by migration)
  firstName     String?  @map("first_name")
  lastName      String?  @map("last_name")
  avatar        String?
  
  // Relations
  apiKeys           ApiKey[]
  organizationUsers OrganizationUser[]
  roles             UserRole[]
  comments          WorkflowComment[]
  documents         WorkflowDocument[]
  assignedAsApprover WorkflowInstance[] @relation("ApproverAssignment")
  assignedAsCustomer WorkflowInstance[] @relation("CustomerAssignment")
  createdWorkflows   WorkflowInstance[] @relation("InstanceCreator")
  createdTemplates   WorkflowTemplate[]
  transitions        WorkflowTransition[]
  
  @@index([email])
  @@index([publicKey])
  @@map("users")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions Json?
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  bitmask     Int?     @default(0)
  
  userRoles   UserRole[]
  
  @@map("roles")
}

model UserRole {
  id         String    @id @default(cuid())
  userId     String    @map("user_id")
  roleId     String    @map("role_id")
  orgId      String?   @map("organization_id")
  templateId String?   @map("template_id")
  grantedBy  String?   @map("granted_by")
  grantedAt  DateTime  @default(now()) @map("granted_at")
  expiresAt  DateTime? @map("expires_at")
  
  organization Organization?     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  role         Role              @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  template     WorkflowTemplate? @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  @@unique([userId, roleId, orgId, templateId])
  @@map("user_roles")
}

model AuthNonce {
  id        String   @id @default(cuid())
  publicKey String   @unique @map("public_key")
  nonce     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([expiresAt])
  @@index([publicKey])
  @@map("auth_nonces")
}

model ApiKey {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  name        String
  keyHash     String    @unique @map("key_hash")
  keyPrefix   String    @map("last_four")
  permissions String[]
  isActive    Boolean   @default(true) @map("is_active")
  expiresAt   DateTime? @map("expires_at")
  lastUsedAt  DateTime? @map("last_used_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("api_keys")
}

// =============================================================================
// Organization / Multi-tenancy
// =============================================================================

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  logoUrl     String?  @map("logo_url")
  isActive    Boolean  @default(true) @map("is_active")
  settings    Json?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  users       OrganizationUser[]
  userRoles   UserRole[]
  instances   WorkflowInstance[]
  templates   WorkflowTemplate[]
  
  @@map("organizations")
}

model OrganizationUser {
  id        String   @id @default(cuid())
  orgId     String   @map("organization_id")
  userId    String   @map("user_id")
  role      String   @default("member")
  joinedAt  DateTime @default(now()) @map("joined_at")
  
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([orgId, userId])
  @@map("organization_users")
}

// =============================================================================
// Workflow Templates
// =============================================================================

model WorkflowTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  version     Int      @default(1)
  status      TemplateStatus @default(DRAFT)
  category    String?
  states      Json
  transitions Json
  roles       Json
  slaConfig   Json?    @map("sla_config")
  slaDays     Int?     @default(7) @map("sla_days")
  escalationDays Int?  @default(3) @map("escalation_days")
  formSchema  Json?    @map("form_schema")
  metadata    Json?
  creatorId   String   @map("created_by")
  orgId       String?  @map("organization_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  publishedAt DateTime? @map("published_at")
  
  // Blockchain Reference
  onChainWorkflowId      BigInt?  @unique
  registrationDeployHash String?
  contractHash           String?  @map("contract_hash")
  
  instances    WorkflowInstance[]
  userRoles    UserRole[]
  creator      User               @relation(fields: [creatorId], references: [id])
  organization Organization?      @relation(fields: [orgId], references: [id])
  
  @@index([orgId])
  @@index([status])
  @@map("workflow_templates")
}

enum TemplateStatus {
  DRAFT
  ACTIVE
  PUBLISHED
  DEPRECATED
  ARCHIVED
  
  @@map("template_status")
}

// =============================================================================
// Workflow Instances
// =============================================================================

model WorkflowInstance {
  id            String   @id @default(cuid())
  templateId    String   @map("template_id")
  title         String   @map("name")
  description   String?
  currentState  Int      @default(0) @map("current_state")
  status        InstanceStatus @default(DRAFT)
  data          Json?
  assignees     String[]
  dueDate       DateTime? @map("due_date")
  priority      Int       @default(0)
  blockchainId  String?   @map("blockchain_id")
  deployHash    String?   @map("deploy_hash")
  workflowId    BigInt?   @unique @map("workflow_id")
  creatorId     String    @map("created_by")
  orgId         String?   @map("organization_id")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  completedAt   DateTime? @map("completed_at")
  submittedAt   DateTime? @map("submitted_at")
  
  // Assignment (camelCase in DB - from enterprise extension migration)
  assignedCustomerId  String?
  assignedApproverId  String?
  
  comments         WorkflowComment[]
  documents        WorkflowDocument[]
  complianceProof  ComplianceProof?
  assignedApprover User?              @relation("ApproverAssignment", fields: [assignedApproverId], references: [id])
  assignedCustomer User?              @relation("CustomerAssignment", fields: [assignedCustomerId], references: [id])
  creator          User               @relation("InstanceCreator", fields: [creatorId], references: [id])
  organization     Organization?      @relation(fields: [orgId], references: [id])
  template         WorkflowTemplate   @relation(fields: [templateId], references: [id])
  transitions      WorkflowTransition[]
  
  @@index([assignedApproverId])
  @@index([assignedCustomerId])
  @@index([creatorId])
  @@index([orgId])
  @@index([status])
  @@index([templateId])
  @@index([workflowId])
  @@map("workflow_instances")
}

enum InstanceStatus {
  DRAFT
  PENDING
  ACTIVE
  PENDING_REVIEW
  IN_REVIEW
  PENDING_APPROVAL
  APPROVED
  REJECTED
  ESCALATED
  CANCELLED
  COMPLETED
  SUBMITTED
  PENDING_CUSTOMER_CONFIRMATION
  CUSTOMER_CONFIRMED
  ONCHAIN_PENDING
  
  @@map("instance_status")
}

// =============================================================================
// Workflow Transitions
// =============================================================================

model WorkflowTransition {
  id          String   @id @default(cuid())
  instanceId  String   @map("instance_id")
  fromState   Int      @map("from_state")
  toState     Int      @map("to_state")
  action      String
  status      TransitionStatus @default(PENDING)
  deployHash  String?  @map("deploy_hash")
  blockHash   String?  @map("block_hash")
  blockHeight BigInt?  @map("block_height")
  executionCost BigInt? @map("execution_cost")
  error       String?  @map("error_message")
  comment     String?
  metadata    Json?
  actorId     String   @map("performed_by")
  createdAt   DateTime @default(now()) @map("created_at")
  confirmedAt DateTime? @map("confirmed_at")
  
  instance    WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  actor       User             @relation(fields: [actorId], references: [id])
  
  @@index([instanceId])
  @@index([status])
  @@map("workflow_transitions")
}

enum TransitionStatus {
  PENDING
  ONCHAIN_PENDING
  CONFIRMED
  CONFIRMED_ONCHAIN
  FAILED
  FAILED_ONCHAIN
  TIMEOUT
  
  @@map("transition_status")
}

// =============================================================================
// Supporting Documents
// =============================================================================

model WorkflowDocument {
  id          String   @id @default(cuid())
  instanceId  String   @map("instance_id")
  name        String
  mimeType    String   @map("file_type")
  size        Int      @map("file_size")
  storageKey  String   @map("file_url")
  checksum    String   @map("hash")
  uploaderId  String   @map("uploaded_by")
  createdAt   DateTime @default(now()) @map("created_at")
  
  instance    WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  uploader    User             @relation(fields: [uploaderId], references: [id])
  
  @@index([instanceId])
  @@map("workflow_documents")
}

// =============================================================================
// Comments & Discussion
// =============================================================================

model WorkflowComment {
  id          String   @id @default(cuid())
  instanceId  String   @map("instance_id")
  content     String
  authorId    String   @map("user_id")
  parentId    String?  @map("parent_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  instance    WorkflowInstance   @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  parent      WorkflowComment?   @relation("CommentThread", fields: [parentId], references: [id])
  replies     WorkflowComment[]  @relation("CommentThread")
  author      User               @relation(fields: [authorId], references: [id])
  
  @@index([instanceId])
  @@map("workflow_comments")
}

// =============================================================================
// Audit Logging
// =============================================================================

model AuditLog {
  id          String   @id @default(cuid())
  action      String
  resource    String   @map("entity_type")
  resourceId  String   @map("entity_id")
  userId      String?  @map("user_id")
  userEmail   String?  @map("user_email")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  oldValues   Json?    @map("old_values")
  newValues   Json?    @map("new_values")
  metadata    Json?
  details     Json?
  deployHash  String?  @map("deploy_hash")
  createdAt   DateTime @default(now()) @map("created_at")
  
  @@index([action])
  @@index([createdAt])
  @@index([resource, resourceId])
  @@index([userId])
  @@map("audit_logs")
}

// =============================================================================
// System Configuration
// =============================================================================

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  description String?
  value       Json
  updatedBy   String?  @map("updated_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@map("system_configs")
}

// =============================================================================
// Deploy Queue (for tracking submitted deploys)
// =============================================================================

model DeployQueue {
  id            String   @id @default(cuid())
  deployHash    String   @unique @map("deploy_hash")
  type          String   @map("entity_type")
  entityId      String   @map("entity_id")
  status        DeployQueueStatus @default(PENDING)
  attempts      Int      @default(0)
  maxAttempts   Int      @default(60) @map("max_attempts")
  error         String?  @map("error_message")
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  confirmedAt   DateTime? @map("confirmed_at")
  
  @@index([type, entityId])
  @@index([status])
  @@map("deploy_queue")
}

enum DeployQueueStatus {
  PENDING
  PROCESSING
  CONFIRMED
  FAILED
  
  @@map("deploy_queue_status")
}

// =============================================================================
// Compliance Proofs
// =============================================================================

model ComplianceProof {
  id                String   @id @default(cuid())
  instanceId        String   @unique @map("instance_id")
  workflowId        String   @map("workflow_id")
  templateId        String   @map("template_id")
  finalState        String   @map("final_state")
  approvedBy        String   @map("approved_by")
  approvedAt        DateTime @map("approved_at")
  
  // Document hashes at time of approval
  documentHashes    Json     @map("document_hashes")
  
  // Blockchain references
  contractHash      String   @map("contract_hash")
  approvalDeployHash String  @map("approval_deploy_hash")
  approvalBlockHash String?  @map("approval_block_hash")
  
  // Proof registration on-chain
  proofHash         String   @map("proof_hash")
  proofDeployHash   String?  @map("proof_deploy_hash")
  proofBlockHash    String?  @map("proof_block_hash")
  
  // Full proof JSON for export/verification
  proofJson         Json     @map("proof_json")
  
  // Status tracking
  status            ComplianceProofStatus @default(PENDING)
  error             String?  @map("error_message")
  
  createdAt         DateTime @default(now()) @map("created_at")
  confirmedAt       DateTime? @map("confirmed_at")
  
  instance          WorkflowInstance @relation(fields: [instanceId], references: [id], onDelete: Cascade)
  
  @@index([status])
  @@index([proofHash])
  @@map("compliance_proofs")
}

enum ComplianceProofStatus {
  PENDING
  ONCHAIN_PENDING
  CONFIRMED
  FAILED
  
  @@map("compliance_proof_status")
}
